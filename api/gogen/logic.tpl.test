//nolint:dupl
//nolint:staticcheck
//nolint:errchkjson
//nolint:errcheck
package testlogic

import (
	"context"
	{{if .HasResp}}"encoding/json"{{end}}
	"fmt"
	"os"
	"path/filepath"
	"testing"

	"app-server/api/{{.ProjectName}}/internal/config"
	{{if .HasRequest}}{{if .NoTypes}}"app-server/api/{{.ProjectName}}/internal/types"{{end}}{{else}}
	{{if .HasResp}}{{if .NoTypes}}"app-server/api/{{.ProjectName}}/internal/types"{{end}}{{end}}
	{{end}}
	"github.com/zeromicro/go-zero/core/conf"

	{{.ImportPackages}}
)

// nolint: staticcheck
func Test_{{.function}}(t *testing.T) {
	var (
		getFilePath = func(rootDir string, subPath ...string) string {
			base := os.Args[0]
			for {
				base = filepath.Dir(base)
				if filepath.Base(base) == rootDir {
					elems := []string{base}
					return filepath.Join(append(elems, subPath...)...)
				}
				if len(filepath.Base(base)) == 0 {
					return ""
				}
			}
		}
		{{if .HasResp}}toJson = func(resp {{.ResponseType}}) (string, error){
			bs, err := json.Marshal(resp) //nolint:errchkjson
			return string(bs), err
		}{{end}}
		configFile = getFilePath("{{.ProjectName}}", "etc", "{{.ProjectName}}-dev.yaml")
		c          config.Config
	)
	conf.MustLoad(configFile, &c)
	svcCtx, ctx := svc.NewServiceContext(c), context.WithValue(context.Background(), "userId", int64(1101001))

	l := {{.LogicName}}.New{{.logic}}(ctx, svcCtx)
	{{if .HasResp}}resp ,{{end}}err := l.{{.Call}}({{if .HasRequest}}&types.{{.RequestType}}{}{{end}})
	{{if .HasResp}}fmt.Println(toJson(resp))
	if err != nil {
		fmt.Println(err)
		t.Failed()
	}{{else}}if err != nil {
		fmt.Println(err)
		t.Failed()
	}{{end}}
}
